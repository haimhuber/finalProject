# חישוב מפורט - יום שישי 5 בדצמבר 2025 ✅

## נתונים
- **תאריך**: 05/12/2025 (יום שישי - סוף שבוע)
- **צריכה יומית**: 116.9 kWh
- **עלות צפויה**: ₪100.42
- **יעילות**: -84%
- **עונה**: חורף (דצמבר)

---

## 1. שיטת החישוב המדויקת - לפי דגימות בפועל! 🎯

### הבעיה בשיטה הישנה:
החישוב הקודם הניח שהצריכה **מתחלקת באופן אחיד** על כל שעות היום:
```
עלות = צריכה × [(5/24 × תעריף_פסגה) + (19/24 × תעריף_שפל)]
     = 116.9 × 0.6123
     = ₪71.56 ❌
```

### השיטה החדשה - חישוב לפי דגימות אמיתיות! ✅

המערכת שומרת **דגימות של ActiveEnergy כל כמה דקות** עם חותמת זמן.

**אלגוריתם החישוב:**

```sql
1. לכל דגימה, בדוק את השעה:
   - אם 17:00-22:00 → זו צריכה בשעות פסגה
   - אחרת → זו צריכה בשעות שפל

2. חשב את הצריכה בין דגימות:
   consumption = ActiveEnergy[i] - ActiveEnergy[i-1]

3. סכם לפי קטגוריה:
   - peak_consumption = סכום כל הצריכה בשעות 17:00-22:00
   - offpeak_consumption = סכום כל הצריכה בשאר השעות

4. חשב עלות:
   daily_cost = peak_consumption × 1.2071 + offpeak_consumption × 0.4557
```

---

## 2. החישוב המדויק ליום 5 בדצמבר

### תעריפים חורף (כולל מע"מ):
- **פסגה (17:00-22:00)**: ₪1.2071/kWh
- **שפל (שאר השעות)**: ₪0.4557/kWh

### דוגמה - אם הצריכה בפועל הייתה:

#### תרחיש 1: צריכה אחידה (20.83% בפסגה)
```
peak_consumption = 116.9 × 0.2083 = 24.35 kWh
offpeak_consumption = 116.9 × 0.7917 = 92.55 kWh

daily_cost = 24.35 × 1.2071 + 92.55 × 0.4557
           = 29.39 + 42.17
           = ₪71.56
```

#### תרחיש 2: צריכה גבוהה בשעות פסגה (60% בפסגה)
```
peak_consumption = 116.9 × 0.60 = 70.14 kWh
offpeak_consumption = 116.9 × 0.40 = 46.76 kWh

daily_cost = 70.14 × 1.2071 + 46.76 × 0.4557
           = 84.66 + 21.31
           = ₪105.97 ✅ (קרוב ל-₪100.42!)
```

### מסקנה:
אם העלות היא ₪100.42, זה אומר שכ-**57% מהצריכה** הייתה בשעות פסגה (17:00-22:00):

```
נסיון ב-57%:
peak_consumption = 116.9 × 0.57 = 66.63 kWh
offpeak_consumption = 116.9 × 0.43 = 50.27 kWh

daily_cost = 66.63 × 1.2071 + 50.27 × 0.4557
           = 80.43 + 22.91
           = ₪103.34

נסיון ב-54%:
peak_consumption = 116.9 × 0.54 = 63.13 kWh
offpeak_consumption = 116.9 × 0.46 = 53.77 kWh

daily_cost = 63.13 × 1.2071 + 53.77 × 0.4557
           = 76.19 + 24.51
           = ₪100.70 ✅ מאוד קרוב!
```

**תוצאה**: כ-**54% מהצריכה** (63 kWh מתוך 116.9 kWh) הייתה בשעות הפסגה 17:00-22:00!

---

## 2. סיכום התעריפים המדויקים

### קיץ (יוני-ספטמבר):
| | ימים א'-ה' | ימי ו' וערבי חג | שבת וחגים |
|---|---|---|---|
| **פסגה** | 17:00-23:00<br>₪1.6895/kWh | אין | אין |
| **שפל** | שאר השעות<br>₪0.5283/kWh | 24 שעות<br>₪0.5283/kWh | 24 שעות<br>₪0.5283/kWh |

### חורף (דצמבר-פברואר):
| | **כל הימים** (כולל שישי-שבת!) |
|---|---|
| **פסגה** | 17:00-22:00 → ₪1.2071/kWh |
| **שפל** | שאר השעות → ₪0.4557/kWh |

### אביב/סתיו (מרץ-מאי, אוקטובר-נובמבר):
| | ימים א'-ה' | ימי ו' וערבי חג | שבת וחגים |
|---|---|---|---|
| **פסגה** | 07:00-17:00<br>₪0.4977/kWh | אין | אין |
| **שפל** | שאר השעות<br>₪0.4460/kWh | 24 שעות<br>₪0.4460/kWh | 24 שעות<br>₪0.4460/kWh |

---

## 2. חישוב היעילות

### פרמטרים:
- `efficiencyBase` = 50 kWh
- `efficiencyMultiplier` = 2
- `daily_consumption` = 116.9 kWh

### נוסחה:
```javascript
efficiency = Math.round(
    Math.min(100, (efficiencyBase - daily_consumption) × efficiencyMultiplier + 50)
)
```

### חישוב צעד-צעד:
```
1. efficiencyBase - daily_consumption
   = 50 - 116.9
   = -66.9

2. הכפל במכפיל
   = -66.9 × 2
   = -133.8

3. הוסף 50
   = -133.8 + 50
   = -83.8

4. לקח מינימום עם 100
   = Math.min(100, -83.8)
   = -83.8

5. עיגול
   = Math.round(-83.8)
   = -84%
```

### הסבר הלוגיקה:
| צריכה | תוצאה | הערה |
|-------|-------|------|
| 0 kWh | 100% | יעילות מקסימלית |
| 25 kWh | 100% | עדיין מצוין |
| 50 kWh | 50% | בסיס |
| 75 kWh | 0% | מתחיל להיות בעייתי |
| 100 kWh | -50% | צריכה גבוהה מדי |
| 116.9 kWh | -84% | **המקרה שלך** - צריכה גבוהה מאוד |

**מסקנה**: אתה צורך פי 2.3 מהבסיס, לכן היעילות שלילית.

---

## 3. שעות שיא

### לפי עונה:
- **חורף (דצמבר-פברואר)**: 17:00-22:00 **בכל הימים** (כולל סופי שבוע!)
- **קיץ (יוני-ספטמבר)**: 17:00-23:00 (ימים א'-ה' בלבד)
- **אביב/סתיו**: 17:00-22:00 (ימים א'-ה' בלבד)

### יום שישי 5 בדצמבר (חורף):
**יש שעות שיא!** → מוצג: **"17:00-22:00"**

⚠️ **שים לב**: בניגוד לעונות אחרות, **בחורף יש שעות שיא גם בסופי שבוע** (שישי-שבת).

זה אומר שביום שישי בחורף:
- 17:00-22:00 (5 שעות) → תעריף שיא ₪0.5712/kWh
- שאר השעות (19 שעות) → תעריף שפל משוקלל

לכן העלות המדויקת היא:
```
116.9 kWh × (0.42 × 0.5712 + 0.25 × 0.4827 + 0.33 × 0.3956)
= 116.9 × 0.491127
= ₪57.40 (ללא מע"מ)
```

---

## קוד רלוונטי

### Frontend - חישוב יעילות (BillingScreen.tsx, שורה 470):
```typescript
const efficiency = Math.round(
    Math.min(100, (efficiencyBase - item.daily_consumption) * efficiencyMultiplier + 50)
);
```

### Backend - חישוב עלות (updateBillingProcedure.sql):
```sql
CASE 
    WHEN month_num IN (12, 1, 2) THEN -- חורף
        daily_consumption * 0.42 * 0.5712 + -- שיא 42%
        daily_consumption * 0.25 * 0.4827 + -- גבע 25%
        daily_consumption * 0.33 * 0.3956   -- שפל 33%
END as daily_cost
```

---

## המלצות

1. **לבדוק אם התעריפים נכונים** - יש פער בחישובים
2. **לשקול להגדיל את efficiencyBase** מ-50 ל-120 אם הצריכה הממוצעת גבוהה
3. **לבדוק למה הצריכה כל כך גבוהה** ביום שישי (116.9 kWh)
